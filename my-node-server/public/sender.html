<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Telesaver — Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/scripts/messages_api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Top bar (centered logo + title) -->
  <header class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white py-4 px-6 flex items-center justify-center shadow-md">
    <div class="flex items-center space-x-3">
      <img src="/assets/telesaver.png" alt="App Logo" class="h-10 w-10 rounded-full shadow-md" />
      <h1 class="text-2xl font-bold">Telesaver — Messages</h1>
    </div>
  </header>

  <!-- Content wrapper -->
  <main class="max-w-4xl w-full mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-semibold text-gray-800">
          Messages from: <span id="sender-name" class="font-bold">Loading...</span>
        </h2>
        <p class="text-gray-500 text-sm mt-1">
          Sender ID: <span id="sender-id">—</span>
        </p>
      </div>
      <a href="/" class="text-blue-600 hover:underline">← Back to senders</a>
    </div>

    <!-- Messages list -->
    <section id="messages" class="bg-white rounded-lg shadow-md">
      <div class="p-6 text-gray-500">Loading messages…</div>
    </section>
  </main>

  <script>
    // --- helpers ---
    function getQueryParam(key){
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function isImage(path){
      return /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(path || "");
    }
    function isVideo(path){
      return /\.(mp4|webm|ogg|mov|m4v)$/i.test(path || "");
    }
    function cleanMediaPath(p){
      // if your stored paths include "my-node-server/public", strip it:
      if(!p) return "";
      return p.replace(/^my-node-server\/public\//, "/");
    }

    // --- render one message card ---
    function renderMessage(msg){
      const ts = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : "—";
      const media = msg.media_path ? cleanMediaPath(msg.media_path) : "";

      // Fixed media width
      const mediaWidth = 280;
      const fake_text = "Hey man this is just a test message to make it look like there is some real text here."

      let mediaHTML = "";
      if (media){
        if (isImage(media)){
          mediaHTML = `<img src="${media}" alt="media" class="mt-3 rounded-lg border max-h-80 object-contain" style="width:${mediaWidth}px;">`;
        } else if (isVideo(media)){
          mediaHTML = `<video src="${media}" controls class="mt-3 rounded-lg border max-h-96" style="width:${mediaWidth}px;"></video>`;
        } else {
          mediaHTML = `<a href="${media}" target="_blank" class="mt-3 inline-block text-blue-600 hover:underline">Download attachment</a>`;
        }
      }

      return `
        <article class="block ml-auto p-6 border-0" style="width:${mediaWidth}px;">
          <div class="flex items-end flex-col">
            ${mediaHTML}
            <div class="flex gap-1 w-full">
              <p class="inline text-gray-800 whitespace-pre-wrap break-words">${fake_text || ""}
              <a class="inline-block mt-1 ml-auto text-xs text-gray-400 hover:text-gray-600">
                ${msg.sent_at.slice(0,10)}
              </a>
              </p>
            </div>
          </div>
        </article>
      `;
    }

    // --- page logic ---
    $(async function(){
      const senderId = getQueryParam("id");
      const api = new MessagesAPI(); // our global API helper

      if(!senderId){
        $("#messages").html(`<div class="p-6 text-red-500">Missing sender id.</div>`);
        return;
      }
      $("#sender-id").text(senderId);

      try {
        const rows = await api.getMessagesBySender(senderId);
        const senderName = (rows && rows[0] && (rows[0].sender_name || rows[0].sender)) || "";
        $("#sender-name").text(senderName || `ID ${senderId}`);

        const box = $("#messages");
        box.empty();
        if(!rows || rows.length === 0){
          box.html(`<div class="p-6 text-gray-500">No messages found for this sender.</div>`);
          return;
        }
        rows.forEach(m => box.append(renderMessage(m)));
      } catch (err) {
        $("#messages").html(`<div class="p-6 text-red-500">Failed to load messages.</div>`);
        console.error(err);
      }
    });
  </script>
</body>
</html>
