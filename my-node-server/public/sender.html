<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Telesaver — Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/scripts/messages_api.js"></script>
  <script src="/socket.io/socket.io.js"></script>

</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Top bar (centered logo + title) -->
  <header class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white py-4 px-6 flex items-center justify-center shadow-md">
    <div class="flex items-center space-x-3">
      <img src="/assets/telesaver.png" alt="App Logo" class="h-10 w-10 rounded-full shadow-md" />
      <h1 class="text-2xl font-bold">Telesaver — Messages</h1>
    </div>
  </header>

  <!-- Content wrapper -->
  <main class="max-w-4xl w-full mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-semibold text-gray-800">
          Messages from: <span id="sender-name" class="font-bold">Loading...</span>
        </h2>
        <p class="text-gray-500 text-sm mt-1">
          Sender ID: <span id="sender-id">—</span>
        </p>
        <p class="text-gray-500 text-sm mt-1">
          Sender Phone: <span id="sender-phone">—</span>
        </p>
      </div>
      <a href="/" class="text-blue-600 hover:underline">← Back to senders</a>
    </div>

    <!-- Messages list -->
    <section id="messages" class="bg-white pb-3 rounded-lg shadow-md">
      <div class="p-6 text-gray-500">Loading messages…</div>
    </section>
  </main>

  <script>

    latest_sent_date = "00-00-0000";

    const socket = io();

    socket.on('updateMessage', (data) => {

      data.sent_at = data.timestamp;

      if(data.sender_id == getQueryParam("external_id")) {
        window.alert("Message Added");
        updateNewMessages(data);
      }

    });

    // --- helpers ---
    function getQueryParam(key){
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function convertToNormalTime(mysqlTimestamp) {
      // Example input: "2025-10-18 18:15:53"
      const [datePart, timePart] = mysqlTimestamp.split(' ');
      let [hours, minutes, seconds] = timePart.split(':').map(Number);

      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12; // convert 0 -> 12, 13 -> 1, etc.

      // zero-pad minutes/seconds just in case
      const pad = (n) => String(n).padStart(2, '0');
      return `${datePart} ${hours}:${pad(minutes)}:${pad(seconds)} ${ampm}`;
    }

    function isImage(path){
      return /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(path || "");
    }
    function isVideo(path){
      return /\.(mp4|webm|ogg|mov|m4v)$/i.test(path || "");
    }
    function cleanMediaPath(p){
      // if your stored paths include "my-node-server/public", strip it:
      if(!p) return "";
      return p.replace(/^my-node-server\/public\//, "/");
    }

    function compareDates(dateStr, compareTo) {
      // Parse the first date
      const [month1, day1, year1] = dateStr.split("-").map(Number);
      const date1 = new Date(year1, month1 - 1, day1);

      // Parse the second date or use today
      let date2;
      if (compareTo) {
        const [month2, day2, year2] = compareTo.split("-").map(Number);
        date2 = new Date(year2, month2 - 1, day2);
      } else {
        const now = new Date();
        // Normalize "today" to midnight to compare only dates
        date2 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      }

      if (date1.getTime() < date2.getTime()) return -1;
      if (date1.getTime() > date2.getTime()) return 1;
      return 0;
    }
   
    // --- render one message card ---
    function renderMessage(msg){

      const ts = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : "—";
      const media = msg.media_path ? cleanMediaPath(msg.media_path) : "";

      // Fixed media width
      const mediaWidth = 280;

      date_header = "";

      //convert date to 12 hour time
      var time_sent_12hours = convertToNormalTime(msg.sent_at);

      if(compareDates(msg.sent_at.slice(0,10), latest_sent_date) == 1){

        latest_sent_date = msg.sent_at.slice(0,10);
        date_header = `<div class="w-full text-center">${latest_sent_date}</div>`;

      }

      let mediaHTML = "";
      if (media){
        if (isImage(media)){
          mediaHTML = `<img src="${media}" alt="media" class="mt-3 max-h-80 object-contain" style="width:${mediaWidth}px;">`;
        } else if (isVideo(media)){
          mediaHTML = `<video src="${media}" controls class="mt-3 max-h-96" style="width:${mediaWidth}px;"></video>`;
        } else {
          mediaHTML = `<a href="${media}" target="_blank" class="mt-3 inline-block text-blue-600 hover:underline">Download attachment</a>`;
        }
      }

      return `
        ${date_header}
        <article class="bg-blue-400 rounded-lg p-2 m-3 block ml-auto p-6 border-0" style="width:${mediaWidth}px;">
          <div class="flex flex-col items-end">
            ${mediaHTML}
            <p class="w-full text-gray-800 whitespace-pre-wrap break-words">${msg.text || ""}</p>
            <a class="self-end text-xs text-gray-900 hover:text-gray-900">${time_sent_12hours.slice(11,22)}</a>
          </div>
        </article>
      `;
    }

    function updateNewMessages(msg){

      const box = $("#messages");

      if(compareDates(msg.sent_at.slice(0,10), latest_sent_date) == 1){

        latest_sent_date = msg.sent_at.slice(0,10);
        date_header = `<div class="w-full text-center">${latest_sent_date}</div>`;

        box.append(date_header);

      }

      box.append(renderMessage(msg))
    }

    // --- page logic ---
    $(async function(){
      const senderId = getQueryParam("id");
      const senderPhone = getQueryParam("phone");
      const external_id = getQueryParam("external_id");

      const api = new MessagesAPI(); // our global API helper

      if(!senderId){
        $("#messages").html(`<div class="p-6 text-red-500">Missing sender id.</div>`);
        return;
      }

      $("#sender-id").text(external_id);
      $("#sender-phone").text(senderPhone || "—");

      try {
        const rows = await api.getMessagesBySender(senderId);
        const senderName = (rows && rows[0] && (rows[0].sender_name || rows[0].sender)) || "";
        $("#sender-name").text(senderName);

        const box = $("#messages");
        box.empty();
        if(!rows || rows.length === 0){
          box.html(`<div class="p-6 text-gray-500">No messages found for this sender.</div>`);
          return;
        }

        rows.forEach(m => box.append(renderMessage(m)));
      } catch (err) {
        $("#messages").html(`<div class="p-6 text-red-500">Failed to load messages.</div>`);
        console.error(err);
      }
    });
  
  </script>
</body>
</html>
