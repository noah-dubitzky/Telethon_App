<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Telesaver — Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/scripts/messages_api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Top bar (centered logo + title) -->
  <header class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white py-4 px-6 flex items-center justify-center shadow-md">
    <div class="flex items-center space-x-3">
      <img src="/assets/telesaver.png" alt="App Logo" class="h-10 w-10 rounded-full shadow-md" />
      <h1 class="text-2xl font-bold">Telesaver — Messages</h1>
    </div>
  </header>

  <!-- Content wrapper -->
  <main class="max-w-4xl w-full mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-semibold text-gray-800">
          Messages from: <span id="sender-name" class="font-bold">Loading...</span>
        </h2>
        <p class="text-gray-500 text-sm mt-1">
          Sender ID: <span id="sender-id">—</span>
        </p>
      </div>
      <a href="/" class="text-blue-600 hover:underline">← Back to senders</a>
    </div>

    <!-- Messages list -->
    <section id="messages" class="bg-white rounded-lg shadow-md divide-y divide-gray-100">
      <div class="p-6 text-gray-500">Loading messages…</div>
    </section>
  </main>

  <script>
    // --- helpers ---
    function getQueryParam(key){
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function isImage(path){
      return /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/i.test(path || "");
    }
    function isVideo(path){
      return /\.(mp4|webm|ogg|mov|m4v)$/i.test(path || "");
    }
    function cleanMediaPath(p){
      // if your stored paths include "my-node-server/public", strip it:
      if(!p) return "";
      return p.replace(/^my-node-server\/public\//, "/");
    }

    // --- render one message card ---
    function renderMessage(msg){
      const ts = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : "—";
      const media = msg.media_path ? cleanMediaPath(msg.media_path) : "";

      let mediaHTML = "";
      if (media){
        if (isImage(media)){
          mediaHTML = `<img src="${media}" alt="media" class="mt-3 rounded-lg border w-full max-h-80 object-contain">`;
        } else if (isVideo(media)){
          mediaHTML = `<video src="${media}" controls class="mt-3 rounded-lg border w-full max-h-96"></video>`;
        } else {
          mediaHTML = `<a href="${media}" target="_blank" class="mt-3 inline-block text-blue-600 hover:underline">Download attachment</a>`;
        }
      }

      return `
        <article class="p-6">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-500">${ts}</div>
            ${msg.channel_id !== null && msg.channel_id !== undefined
              ? `<span class="text-xs px-2 py-1 bg-gray-100 rounded border text-gray-600">channel: ${msg.channel_id}</span>`
              : `<span class="text-xs px-2 py-1 bg-blue-50 rounded border border-blue-100 text-blue-700">direct</span>`
            }
          </div>
          <p class="mt-2 text-gray-800 whitespace-pre-wrap break-words">${msg.message || ""}</p>
          ${mediaHTML}
        </article>
      `;
    }

    // --- page logic ---
    $(async function(){
      const senderId = getQueryParam("id");
      if(!senderId){
        $("#messages").html(`<div class="p-6 text-red-500">Missing sender id.</div>`);
        return;
      }
      $("#sender-id").text(senderId);

      // Fetch messages for this sender

      const api = new MessagesAPI();

      // Fetch senders
      api.getSenders().then(data => console.log('Senders:', data));

      // Fetch messages for sender id=123
      api.getMessagesBySender(senderId).then(msgs => console.log('Msgs:', msgs));

      /*
      $.get(`/messages/sender/${senderId}`, function(rows){
        // Optional: if your API also returns sender info, set name here.
        // Otherwise we can infer from first row or just show the ID.
        const senderName = (rows && rows[0] && (rows[0].sender_name || rows[0].sender)) || "";
        $("#sender-name").text(senderName || `ID ${senderId}`);

        const box = $("#messages");
        box.empty();
        if(!rows || rows.length === 0){
          box.html(`<div class="p-6 text-gray-500">No messages found for this sender.</div>`);
          return;
        }
        rows.forEach(m => box.append(renderMessage(m)));
      }).fail(function(xhr){
        $("#messages").html(`<div class="p-6 text-red-500">Failed to load messages: ${xhr.responseText || xhr.status}</div>`);
      });
      */
    });
  </script>
</body>
</html>
