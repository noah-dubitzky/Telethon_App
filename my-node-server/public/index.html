<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-blue-600 text-white py-4 px-6 flex items-center justify-center shadow-md">
    <div class="flex items-center space-x-3">
        <img src="/assets/telesaver.png" alt="App Logo" class="h-14 w-14 rounded-full shadow-md" />
        <h1 class="text-2xl font-bold">Telesaver Dashboard</h1>
    </div>
  </header>


  <!-- User Info -->
  <section class="text-center mt-8">
    <h2 class="text-2xl font-semibold text-gray-800">Welcome, <span id="username" class="font-bold">Noah Dubitzky</span></h2>
  </section>

  <!-- Senders List -->
  <section class="max-w-2xl w-full mx-auto bg-white rounded-lg shadow-md mt-10 p-6">
    <h3 class="text-xl font-semibold text-gray-700 mb-4">Messages</h3>
    <div id="senders-container" class="divide-y divide-gray-200">
      <p class="text-gray-500">Loading senders...</p>
    </div>
  </section>

  <script>

    sender_ids = [];
    channel_ids = [];
    const socket = io();

    socket.on('updateMessage', (data) => {

      if(data.channel_name == null && !sender_ids.includes(data.external_sender_id)) {
        sender_ids.push(data.external_sender_id);

        UpdateNewSender(data);

        window.alert("new sender added");

      }

    });

    $(document).ready(function () {

      const container = $("#senders-container");
      container.empty();

      $.get("/messages/entities", function (data) {

        window.alert("loaded senders and channels");
    
        if (data.length === 0) {
          container.append("<p id='no_sender_found' class='text-gray-500'>No senders or channles found.</p>");
        } else {
          data.forEach(entity => {

            if(entity.entity_type === "channel"){

              channel_ids.push(entity.id);

              PrependNewChannel(entity);

            }else{

              sender_ids.push(entity.external_sender_id);
              
              PrependNewSender(entity);
            }
          });
        }
      }).fail(function (xhr) {
        $("#senders-container").html("<p class='text-red-500'>Failed to load channels and senders: " + xhr.responseText + "</p>");
      });


    });
  
    UpdateNewSender = (sender) => {

      $.get("/messages/senders/" + sender.sender_id, function (data) {

        PrependNewSender(data);
        $("#no_senders_found").remove();
        
      }).fail(function (xhr) {
        console.error("❌ Error:", xhr.responseText);
        alert("Error: " + xhr.responseText);
      });

      

    }

    PrependNewSender = (sender) => {

      $("#senders-container").prepend(
        `<div class="py-3 hover:bg-gray-50 transition">
          <a href="/sender.html?id=${sender.id}&external_id=${sender.external_sender_id}&phone=${sender.phone}" class="flex items-center text-blue-600 hover:underline">
            <span class="font-medium">${sender.name}</span>
            ${sender.external_sender_id ? `<span class="ml-2 text-gray-500 text-sm">(${sender.external_sender_id})</span>` : ""}
          </a>
        </div>`
      );

    }

    PrependNewChannel = (channel) => {

      $("#senders-container").prepend(
        `<div class="py-3 hover:bg-gray-50 transition">
          <a href="/channels.html?id=${channel.id}&name=${(channel.name)}" class="flex items-center text-green-600 hover:underline">
            <span class="font-medium">${channel.name}</span>      
          </a>
        </div>`
      );

    }

  </script>
</body>
</html>
